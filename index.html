<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aplikasi Chatting Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    /* ... (gunakan CSS Anda seperti sebelumnya tanpa perubahan) ... */
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="container" id="loginPage">
    <h2>Login Chat App</h2>
    <form id="loginForm">
      <label>Email</label>
      <input type="email" id="email" required />
      <label>Password</label>
      <input type="password" id="password" required />
      <label>Token</label>
      <input type="text" id="tokenInput"required placeholder="Masukkan token" />
      <div class="token-display">
        Token Login: <span id="generatedToken"></span>
      </div>
      <button type="submit" style="background:#25d366;">Login</button>
    </form>
    <div class="saved-accounts">
      <h4>Akun Pernah Login:</h4>
      <ul id="accountList"></ul>
    </div>
  </div>

  <!-- Chat Page -->
  <div class="container" id="chatPage" style="display:none;">
    <div class="chat-header">
      <h3 id="userTitle">Selamat datang</h3>
      <div style="display:flex; gap:10px;">
        <button onclick="hapusChat()" title="Hapus semua chat">üóëÔ∏è</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Tulis pesan..." />
      <button class="voice-btn" onclick="startVoice()">üé§</button>
      <button onclick="sendMessage()">Kirim</button>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA40-QnQ-_zoSO368YapJrwClWSnrbsD3o",
      authDomain: "chat-a1733.firebaseapp.com",
     databaseURL: "https://chat-a1733-default-rtdb.firebaseio.com",
     projectId: "chat-a1733",
    storageBucket: "chat-a1733.firebasestorage.app",
    messagingSenderId: "4651885934",
    appId: "1:4651885934:web:a74f548f04f24e52fc0d7f",
    measurementId: "G-TZN8M2B90S"
   }
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const token = Math.random().toString(36).substring(2,8).toUpperCase();
    document.getElementById("generatedToken").textContent = token;

    const getInitial = email => email.charAt(0).toUpperCase();

    function loadAccounts() {
      const accs = JSON.parse(localStorage.getItem('accounts'))||[];
      const list = document.getElementById("accountList");
      list.innerHTML="";
      accs.forEach(acc=>{
        const li=document.createElement("li");
        li.textContent=acc.email;
        list.appendChild(li);
      });
    }
    loadAccounts();

    document.getElementById("loginForm").addEventListener("submit",function(e){
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const inputToken = document.getElementById("tokenInput").value.trim().toUpperCase();
      if(inputToken!==token){ alert("Token salah!"); return; }

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          let accs = JSON.parse(localStorage.getItem('accounts')) || [];
          if (!accs.some(a => a.email === email)) {
            accs.push({ email, password });
            localStorage.setItem('accounts', JSON.stringify(accs));
          }
          sessionStorage.setItem('currentUser', email);
          showChatPage(email);
        })
        .catch(error => {
          alert("Gagal login: " + error.message);
        });
    });

    function logout(){
      sessionStorage.removeItem("currentUser");
      auth.signOut().then(() => {
        location.reload();
      });
    }

    function hapusChat(){
      const email = sessionStorage.getItem("currentUser");
      if(!email) return;
      if(confirm("Hapus semua chat?")){
        db.ref("chats/" + btoa(email)).remove();
        loadChats(email);
      }
    }

    function showChatPage(email){
      document.getElementById("loginPage").style.display="none";
      document.getElementById("chatPage").style.display="block";
      document.getElementById("userTitle").textContent=`Halo, ${email}`;
      loadChats(email);
    }

    function sendMessage(){
      const input = document.getElementById("chatInput");
      const msg=input.value.trim();
      const email=sessionStorage.getItem("currentUser");
      if(!msg||!email) return;
      const chatData = {
        message: msg,
        time: new Date().toLocaleTimeString(),
        user: email
      };
      db.ref("chats/" + btoa(email)).push(chatData);
      input.value="";
    }

    function loadChats(email){
      const box = document.getElementById("chatBox");
      box.innerHTML="";
      db.ref("chats/" + btoa(email)).on("value", snapshot => {
        box.innerHTML = "";
        snapshot.forEach(child => {
          const chat = child.val();
          const div=document.createElement("div");
          div.className="chat-message me";
          div.innerHTML=`
            <div class="avatar">${getInitial(chat.user)}</div>
            <div class="message-bubble">${chat.message}<br><small>${chat.time}</small></div>`;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      });
    }

    // Voice input
    let recognition;
    function startVoice() {
      const input = document.getElementById("chatInput");
      if (!('webkitSpeechRecognition' in window)) {
        alert("Browser Anda tidak mendukung input suara.");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'id-ID';
      recognition.interimResults = false;
      recognition.onresult = function(event) {
        input.value = event.results[0][0].transcript;
      };
      recognition.start();
    }
  </script>
</body>
</html>
